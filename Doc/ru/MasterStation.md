# Станция сопряжения

![](/Images/MasterStation1.jpg?raw=true "Станция сопряжения в корпусе распечатанном на 3д-принтере")

ИЛИ

![](/Images/w06.jpg?raw=true "Станция сопряжения в корпусе G1020BF")

Станция сопряжения работает от компьютера, питание через USB. Схема и плата доступны в [Upverter](https://upverter.com/AlexanderVolikov/3fc0efdb2586988d/Sportiduino-reading-stantion/)

![](/hardware/MasterStation/usb/Scheme.PNG)

Все компоненты схемы можно разместить на печатной плате или всё припаять к Arduino навесным монтажом обычными проводами (рекомендуется провод МГТФ-0,12). Электронику мастер станции можно разместить в корпусе Gainta G1020BF или в специально-разработанном корпусе, который можно распечатать на 3д принтере. [Подробнее про сборку тут](/Doc/ru/MasterStationAssembly.md).

Станция подключается к компьютеру с помощью USB соединения. В Arduino nano уже встроен Serial-USB преобразователь, поэтому дополнительных конвертеров не нужно. Станция отобразится в подключенных устройствах как COM-порт. 

Передача и получение информации происходит последовательно с помощью передачи пакетов до 32 байт. Если передаваемые данные не помещаются в пакет, то передача производится последовательной пересылкой пакетов.

||значение|адрес байта в пакете|
|---|---|---|
|старт|0xFE|0|
|функция||1|
|длина данных, если пакет не полный, (номер пакета+0x1E), если пакетов несколько||2|
|массив данных||3--x (x<31)|
|контрольная сумма||x+1|

Пакет начинается со стартового байта 0xFE

Команда задается байтом с адресом 1. Затем в байте 2 следует длина пакета, если передаваемый пакет последний либо его номер+30, если идёт многопакетная передача. Факт, что в байте 2 значение меньше 30 подтверждает конец передачи данных.

Далее идёт массив передаваемых данных до 28 байтов.

В конце пакета содержится контрольная сумма (остаток от деления суммы байтов функции, длины данных и самих данных на 256). Команды проходят только при верном значении контрольной суммы и стартовых байтов.

Список команд передаваемых на станцию:

|функция|Команды|длина|Массив данных по байтам (в скобах адрес в массиве)|
|---|---|---|---|
|0x41|Записать время на мастер-чип|6|год-2000(0) месяц(1) день(2) час(3) минута(4) cекнуда(5)
|0x42|Записать номер станции на мастер-чип|1|номер(0)
|0x43|Записать пароль и настройки на мастер-чип|7|новый пароль (0-2) старый пароль (3-5) настройки (6) усиление антенны (7)
|0x44|Инициализировать чип|15|номер чипа (0-1), текущее время (2-5), информация в 6-7 страницы (6-13)
|0x45|Передать параметры 6,7 стр|8|информация в 6-7 страницы (0-7)
|0x46|Запрос версии прошивки мастер-станции|0|
|0x47|Записать съемщик лога|0|
|0x48|Считать съемщик лога|0|
|0x4B|Считать чип|0|
|0x4C|Считать сырые данные с чипа|0|
|0x4E|Записать мастер-чип сна|0|
|0x4F|Установить текущий пароль|3|(0-2) пароль|
|0x50|Создать мастер-чип для чтения состояния станции|0|
|0x51|Считать тип чипа|0|
|0x58|Три коротких сигнала (ошибка)|0|
|0x59|Длинный сигнал (ОК)|0|

Список ответов передаваемых станцией:

|функция|Команды|длина|Массив данных по байтам ( в скобах адрес в массиве)|
|---|---|---|---|
|0x61|Передача лога|много пакетов|(первый пакет - номер станции (0)), номер отметившегося чипа 1(1-2), номер отметившегося чипа 2(3-4),…
|0x63|Передача данных с чипа отметки|много пакетов|(первый пакет - номер чипа (0-1), информация в 6-7 страницах чипа (2-9),) номер кп0 (10), время кп0 (11-14), номер кп1 (15), время кп1 (16-19),…
|0x65|Передать сырые данные с чипа|много пакетов|номер страницы 4(0), байты страницы 4(1-4), номер страницы 5(5), байты страницы 5(6-9),…
|0x66|Передать номер прошивки мастер-станции|1|номер прошивки(0)|
|0x69|Передать режим работы мастер станции|1|режим работы мастер-станции(0)|
|0x70|Передать тип чипа|1|тип чипа(0)|
|0x78|Ошибка|1|код ошибки(0), тип чипа (1)
|0x79|ОК|1|тип чипа (0)|

Коды ошибок:

|N|ошибка|
|---|---|
|0x01|ошибка передачи данных через ком-порт|
|0x02|ошибка записи чипа|
|0x03|ошибка чтения чипа|
|0x04|ошибка чтения EEPROM|
|0x05|чип не найден|

