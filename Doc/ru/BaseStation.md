# Станция отметки

### Схема и монтаж

Основные компоненты станции отметки: микроконтроллер - Atmega328p-au, RFID-модуль RC522, часы DS3231SN. Питание от 3х батареек АА через линейный стабилизатор MCP1700T-33. Схема и плата выполнены в программе KiCad.

![](/hardware/BaseStation/prod/sportiduino-base-scheme.jpg?raw=true "Принципиальная схема")

Монтаж компонентов проходит на печатной плате, с платой RFID соединение пайкой через штырьковый разъём. Можно заказать изготовление плат в Китае, за партию в 30 плат это обойдётся порядка 50 рублей за штуку с доставкой.

![](/hardware/BaseStation/prod/sportiduino-base-assembly.jpg?raw=true "Расположение компонентов")

Для прошивки микроконтроллера потребуется другой Arduino с установленной прошивкой ArduinoAsIsp или любой программатор для микроконтроллеров AVR, например, Pickit2.

Печатные платы и батарейный отсек размещаются в пластиковом корпусе Gainta G1020BF. Для защиты электроники от осадков и конденсата внутрь корпуса после сборки заливается компаунд. Про сборку станции и прошивку более подробно написано в [инструкции по сборке](/Doc/ru/BaseStationAssembly.md)

### Потребление

Для уменьшения потребления во время ожидания соревнований, реализован режим Sleep mode для контроллера а также для RC522, при этом потребляется 0.09 мА. На плате RFID необходимо  обязательно выпаять/выломать светодиод и подтягивающий резистр к линии RST, иначе потребление будет несколько мА. Во время работы датчика потребляется до 20 мА (до 40 мА во время считывания-записи), один цикл опроса карточки занимает до 20 мс. 

По умолчанию станция запускается в режиме ожидания. При этом происходит считывание чипов раз в cекунду. Интегральное потребление до 0.5 мА. Полностью заряженных батарей хватит примерно на 160 дней. При подносе чипа (это делает судья-установщик или первый спортсмен) станция переходит в рабочий режим, по-умолчанию, после 6 часов бездействия возвращается обратно в режим ожидания (время можно менять с помощью байта настроек см. ниже).

В рабочем режиме реализовано вхождение в сон каждые 250 мс, таким образом, во время работы можно ожидать интегральное потребление порядка 1,7 мА. Полностью заряженных батарей хватит примерно на 45 дней непрерывной работы.

В режиме сна станция интегрально потребляет  0.09 мА. Полностью заряженных батарей хватит на 5 лет. При подносе любого чипа станция переходит в активный режим.

### Настройка

Настройка станции отметки производится мастер-чипами или через преобразователь Usb-to-TTL. Более подробно написано в [руководстве пользователей](/Doc/ru/UserManual.md)

### Алгоритм работы станции

После подачи питания станция сначала проверяет настройку часов. Если часы настроены не правильно, то станция издаёт соответствующий сигнал. Затем станция загружает из EEPROM байт настроек,
номер станции и пароль. После этого проверяется уровень заряда батареек. На 5 секунд включается светодиод. Если уровень заряда батареек низкий, то станция издаёт соответствующий сигнал. В конце процесса инициализации станция издаёт один продолжительный сигнал и переходит в режим ожидания. В режиме ожидания станция просыпается каждую секунду и ищет метку. При обнаружении чипа переходит в рабочий режим с опросом чипа каждые 0.25 секунды. При подносе чипа, станция считывает 1-ый блок чипа, где хранится номер чипа или отметка мастер-чипа, в случае нахождения которой происходит их обработка. Если чип является обычным, то происходит поиск последней записанной страницы и считывание номера станции в последней отметке. Если номер станции совпадает с последней отметкой, то станция издает более длинный светозвуковой сигнал. Если номер отличный, то производится запись отметки в блок следующую после записанного. В случае успеха, станция подает сигнал, а также записывает факт отметки во внутреннюю EEPROM память станции (в бит, соответствующий номеру чипа). По умолчанию последняя отметка ищется методом бинарного поиска и его скорость зависит от максимального объема чипа. Поиск и запись занимает для разного объема:

- 32 отметки - от 60 до 120 мс
- 64 отметки - от 60 до 140 мс
- 120 отметок - от 60 до 160 мс
- 220 отметок - от 60 до 180 мс

Плюс к этому добавляется время при котором станция находится в спящем режиме. То есть, в режиме ожидания добавляется от 0 до 1000 мс, в рабочем режиме от 0 до 250 мс.
Можно включить режим быстрой отметки. В этом режиме номер последней отметки всегда записывается в 6-ю страницу чипа. Таким образом не требуется длительный поиск последней страницы, но при этом сокращается время службы чипа, потому что 6-я страница чипа будет очень часто перезаписываться.

Во время всей работы станции запущен watch-dog, который при зависании системы её перезагружает.

### Байт настроек

Программируется с помощью мастер-чипа настроек. Отвечает за продолжительность рабочего режима согласно таблице ниже, за режим работы станций – с или без отдельных станций старта и финиша, проверка просроченности чипов, настройка мощности антены и сохранение или удаление настроек после перезагрузки. Во включенном режиме станций старта и финиша (который необходим при работе с программой SportOrg) станция старта (номер = 240) будет принимать только очищенные чипы, другие станции будут реагировать на чип только с отметкой на стартовой станции, а после станции финиша (номер =245) чипом уже будет нельзя отметиться на других станциях до очистки. Это позволит избежать досадных ошибок и случайностей. По умолчанию, байт настроек равен 0. Также настраивается сохранение или сброс настроек при выводе станции из сна.

![](/Images/setting-byte-ru.png?raw=true)

### Станция очистки

Для перевода станции в режим очистки нужно задать станции номер 249.
В режиме очистки станция проводит очистку всех страниц чипа кроме страницы с номером чипа и страниц заданной информации. То есть, стираются все отметки, заданный номер чипа остается прежним. В страницу времени инициализации записывается новое время, которое используется при обсчете результатов, поэтому важно чтобы время на станции было корректным.

При поднесении чипа, на станции загорается светодиод и мигает до тех пор пока не закончится очистка (около 5 секунд). При успешной очистке станция издает сигнал, светодиод гаснет, чип нужно убрать. Если сигнала не было, очистка не была завершена, нужно повторить процедуру.

### Станция проверки

Для перевода станции в режим проверки нужно задать станции номер 248.
В режиме проверки станция ничего на чип не записывает а только проверяет его. Если чип не пустой или время иницализации превышает время на станции более чем на месяц, станция молчит. Если всё в порядке, то станция издаёт один короткий сигнал. Время проверки примерно совпадает со временем отметки поэтому участники могут на этой станции потренировать отметку.

### Система паролей

Поскольку система открытая и все спецификации доступны каждому, кто-то может записать с помощью NFC-устройства любой мастер-чип. Есть возможность вандализма - перепрограммирование установленных станций. И тут, в отличии от того, если бы станцию просто разбили, в результаты может попасть ошибка, которую трудно заметить и которая может повлиять на места. Для защиты от этого явления была введена система паролей.

Пароль состоит из трех чисел от 0 до 255 (трех байт). Пароль по-умолчанию - 0,0,0. Для передачи пароля на станцию отметки используется мастер-чип настроек. При прикладывании этого чипа к станции отметки, если старый пароль совпадает, то записывается новый пароль. Все мастер-чипы работают только при правильном пароле в первой строчке. Также копируется байт настроек. Станция пикает два раза и перезагружается. Информацию о паролях и настройке станции хранят в EEPROM памяти. 

### Сигналы

(длительность миллисекунд, число повторений)

Ошибки:

- 100, 2 - ошибка при чтении еепром памяти; 
- 100, 3 - не верно идут часы; 
- 100, 4 - не подходит пароль мастер чипа; 
- 100, 5 - нужно заменить батареи; 
- 100, 6 - попытка присвоить станции номер 0; 

Нормальное поведение:

- 1000, 1 - сигнал при загрузке станции; 
- 500, 1 - напряжение нормальное; 
- 250, 2 - повтор прикладываемого чипа; 
- 500, 1 - на чип записана отметка;
- 500, 1 - чип очищен на станции очистки; 
- 500, 1 - чип нормальный при проверке; 

Чтение мастер-чипов

- 500, 2 - прочитан мастер чип паролей; 
- 500, 3 - станция прочитала мастер-чип времени; 
- 500, 4 - прочитан мастер чипа сна; 
- 500, 5 - станция прочитала мастер-чип номера; 
- 500, 6 - прочитан мастер чип дампа; 
