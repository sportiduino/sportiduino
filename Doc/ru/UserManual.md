# Руководство пользователя
 
Данная инструкция несет общий характер и предназначена для пользователей. Более подробная информация по устройству, а также инструкции по сборке находится на гитхабе: https://github.com/alexandervolikov/sportiduino/

## Общая информация

### Чипы

Рекомендованными для использования являются чипы Ntag215. Их памяти хватает на запись 120 отметок c записью полного времени (год-месяц-день-час-минута-секунда). Могут быть выполнены в разном форм-факторе. Отдельные чипы могут неуверенно срабатывать на станциях, зависит от площади антенны.

### Базовые станции

Представляют собой небольшие коробочки с фланцами, весят около 150 грамм. Питание от 3 батареек АА, в зависимости от режима работы батареек хватает от 45 дней до 2 лет. Кнопок и другого интерфейса на станции нет, весь обмен информацией, запись чипов происходит в бесконтактном режиме, оптимальная зона срабатывания 0.5-1 см над оранжевой наклейкой. В станции установлены часы, обладающие малой погрешностью хода, но станции не являются прибором точного времени, время нужно регулярно корректировать. 

Для обеспечения более длительной работы от батареи базовые станции могут работать в трех режимах:

* Спящий режим. Для хранения станций между соревнованиями. Опрос чипа происходит раз в 25 секунд. Практически не потребляют энергию. Батарей хватит более чем на 2 года. Для перевода в данный режим используются специально записанные мастер-чипы. Вывод осуществляется прикладыванием любого чипа. Также при выводе из сна происходит очистка внутренней памяти
* Режим ожидания. Опрос чипа раз в 1 секунду. По умолчанию, при отметке чипом переходит в рабочий режим. Батарей хватит примерно на полгода.
* Рабочий режим. Опрос чипа раз в 0.25 секунд. Самый быстрый режим отметки. Батарей хватит на 45 дней. По умолчанию, при бездействии более 6 часов переходит в режим ожидания.

Базовые станции в зависимости от заданного им номера (число от 1 до 255) могут выполнять разные функции:

1-239 - обычные станции отметки. При поднесении чипа записывают в него новые данные и выдают сигнал. При повторном поднесении чипа не производят запись, выдают сигнал. В режиме работы станции старта/финиша не производят отметку и не сигналят для чипов, которые не стартовали или не финишировали.

240 – станция старта. В режиме работы станции старта/финиша не производят отметку и не сигналят, если чип не пустой. В обычном режиме работают как обычные базовые станции

245 – станция финиша. Работает как обычная базовая станция

248 – станция проверки. Если чип пустой и время его инициализации/очистки не отстает более чем на месяц от текущего, станция пикает один раз, иначе – три. Станция ничего не записывает на чип и работает по скорости как обычная, так что на ней участники также могут потренироваться в отметке.

249 – станция очистки. Стирает весь чип, оставляя неизменным номер, а также обновляет время инициализации на чипе. При поднесении чипа загорается светодиод и горит все время процедуры очистки, звуковой сигнал говорит об успешности процедуры. При поднесении повторно только что очищенного чипа станция просто издает сигнал.

###Мастер станция

Станция с разъемом USB для подключения к компьютеру нужна для настройки системы, записи и считывания чипов.

## Инструкция для участников

Данную инструкцию целесообразно распечатать крупным шрифтом и повесить для ознакомления участникам на соревнованиях.

* Для отметки нужно поднести чип к области над оранжевой наклейкой.
* В случае успешной отметки станция издаст звуковой сигнал и (или) мигнет светодиодом
* Оптимальный диапазон срабатывания - около 1 см над оранжевой наклейкой. 
* Если подносить чип вплотную, или если чип далеко от станции, отметка может сработать не с первого раза. 
* При отметке не нужно двигать чип из стороны в сторону, это затрудняет чтение и запись чипа.
* Если не получилось отметиться, уберите чип и вновь поднесите его, медленно опуская его к станции над оранжевой наклейкой.
* Время отметки составляет от 0,06 до 0,4 секунды, если станция находится в рабочем режиме.
* Если Вы пришли на станцию первым, её, возможно, нужно разбудить, время отметки в таком случае составит от 0,06 до 1,2 секунды.
* Отметка бесконтактная, ни на что нажимать не нужно.
* При попытке повторной отметки станция произведет более длительный сигнал без записи новой отметки. Если не уверены, отметились ли вы с первого раза, стоит повторить.
* Без отметки на стартовой станции чипы могут не срабатывать, в данном случае нужно вернуться на старт

## Инструкция для постановщиков

Для работы со станциями необходимо использовать программу SportiduinoPQ, это подготовка чипов, настройка станций. Чтение чипов и подсчет результатов реализован в программе SportOrg.

Программу SportiduinoPQ можно скачать в последнем релизе https://github.com/alexandervolikov/SportiduinoPQ/releases. В релизе присутствует exe файл, не требующий установки. При работе программы весь лог сохраняется в подпапку log.

Программа SportOrg доступна по адресу: http://sportorg.o-ural.ru/ Там же размещена инструкция пользователя

### Подключение мастер-станции

Для подключения станции нужно нажать кнопку Connect. Если подключение удалось, в логе отобразится "master station is connected". 
Если подключить станцию не удается, проверьте правильность соединения. Проблемы могут возникнуть, если в системе используется другое устройство, связанное через com порт. В таком случае нужно через Панель управления - Диспетчер устройств выяснить номер com порта, присваиваемый станции и выбрать его вместо "auto". Также, станции на Arduino Nano с чипами CHG340 могут не работать без установки соответствующего драйвера.

### Подготовка чипов.

Пустые чипы необходимо инициализировать (записать на них номер и текущее время). Для этого во вкладке Card вбить номер чипа. Поднести чип к станции и нажать кнопку Init Card. Процесс инициализации занимает в зависимости от чипа от 3 до 7 секунд. В случае успеха станция издаст один сигнал. Если стоит галочка autoincrement, то число в поле ввода увеличится на 1. Если процесс прошел неудачно (три коротких сигнала и один длинный), попробуйте повторить процедуру.

Номер чипа можно задать в диапазоне от 1 до 65535. Но базовые станции при отметке чипов с номером более 4000 не будут запоминать факт их отметки, поэтому рекомендуется ограничиться номерами до 4000.

При инициализации помимо номера чипа записывается и время инициализации, которое необходимо для последующего считывания чипа, если с момента инициализации или очистки прошло более полугода, данные будут некорректными. Поэтому желательно инициализировать чипы не за долго до соревнований.

Уже ранее инициализированные чипы можно очистить с сохранением номера на станции очистки.
Подготовка станций

### Мастер-чипы

Для настройки станций используются мастер-чипы. Мастер-чип – это обыкновенный чип с записанными на него данными для передачи их на базовую станцию. Чтобы записать мастер-чип, нужно поднести его к мастер-станции и нажать нужную кнопку в зависимости от задачи. Рекомендуется отобрать чип специально для использования в этих целях и как-нибудь его пометить, чтобы избежать попадание его в кучу с чипами участниками, так как в этом случае возможны различные неожиданные ситуации, если чип окажется активным. После каждого использования чипа, он деактивируется, необходимо его записывать каждый раз при использовании.

Для настройки станций, если они находится в состоянии сна, необходимо их сначала разбудить – поднести любой чип на время до 30 секунд. Произойдет процедура выхода из состояния сна: на 5 секунд загорится светодиод, станция измерит заряд батарей (если заряд нормальный выдаст один длинный сигнал, если батарейки нужно заменить пять коротких). После чего перезагрузится и через 5 секунд издаст один короткий сигнал. Если станция издаст три коротких сигнала за 5 секунд до длинного, то на ней часы идут неверно, их нужно настроить.

### Настройка времени станции

Для настройки времени нужно приложить чип к мастер-станции и нажать Set Time во вкладке Station. Станция издаст три сигнала с интервалом в секунду. После второго сигнала нужно приложить чип к базовой станции. При этом станция издаст 3 сигнала и перезагрузится. Если последний сигнал мастер станции и первый сигнал базовой станции слились в один, то время настроено достаточно точно. Настройку времени лучше проводить в рабочем режиме станции в виду более короткого периода неактивности станции.

Погрешность хода часов (при условии использования качественных компонентов и соблюдения технологии пайки) составляет 1 секунду в неделю. Для критически важных станций – старта, финиша рекомендуется обновлять время в день соревнований.

### Присвоение номера станции

Набрать номер станции (от 1 до 239), поднести чип к станции и нажать кнопку Set Number. После чего данный чип поднести к станции. Станция издаст 5 сигналов и перезагрузится с новым номером. 

Для задания специальных станций выделены отдельные кнопки
Set Start – станция старта
Set Finish – станция финиша
Check St – станция проверки
Clear St – станция очистки

### Перевод станций в спящий режим

После соревнований рекомендуется перевести все станции в спящий режим для продления работы от батарей. Для этого нужно поднести чип к мастер-станции, нажать Sleep Card и поднести его к базовой станции. Станция издаст 4 сигнала, перезагрузится и войдёт в спящий режим. Для вывода станций из этого режима нужно приложить к ней чип на время до 30 секунд.

### Настройка станции

В режиме по умолчанию станция не использует пароли, отдельные стартовые и финишные станции, не проверяет время инициализации, объем чипа определяется автоматически, а время перехода из рабочего режима в режим ожидания равен 6 часам, пароли не используются. Если данные параметры не устраивают, то их можно настроить. Для этого во вкладке Settings нужно изменить нужные параметры, поднести чип и нажать Pass Master. Мастер-станция издаст два сигнала, поднести чип к базовой станции, которая также издаст два сигнала и перезагрузится.

Использование паролей защищает станции от возможности их программирования чужими мастер-чипами с неверным паролем, что может защитить от подобного вандализма. Для использования паролей нужно ввести три байта старого пароля (числа от 0 до 255). По умолчанию, это три нуля. Также следует учесть, что при переводе станций в режим сна, пароль сбрасывается на пароль по умолчанию - 0.

Настройки вместе с паролями можно сохранить, нажав кнопку save, потом их можно загрузить - load. Рекомендуется сохранять настройки при задании новых паролей, чтобы их запомнить. 

### Снятие лога станции

В ходе работы базовая станция ведет лог – записывает факт отметки теми или иными номерам чипов. Время отметки при этом не записывается, лог ведется только для чипов с номерами до 4000. С использованием этой функции возможно восстановление части данных в случае утери чипов, проверки спорных ситуаций, а также в поиске сошедших или потерявшихся участников.

Для снятия лога нужно записать мастер-чип, для этого поднести чип к мастер станции и нажать Sump Card во вкладке Station. Процесс подготовки мастер-чипа занимает 5 секунд. После чего поднести мастер чип к базовой станции. Процесс длительный, нужно аккуратно держать чип в оптимальной области записи (0.5 - 1 см над оранжевой меткой). После успешного снятия лога поднести чип к мастер-станции и нажать Read Dump. Результат появится в логе.

## Чтение чипов, формирование результатов

Для чтения чипов и формирования результатов рекомендуется использовать программу SportOrg. Особенность использования данной программы заключается в том, что необходимо использовать стартовую станцию (240) и финишную станцию (245), иначе при чтении будет происходить ошибка. Можно предварительно отметить все чипы на станции старта, раздать участникам, а дальше в программе задать время старта либо задать отсчет старта от произвольной станции. Также можно перевести станции в режим работы со станциями старта/финиша, чтобы избежать ошибки.

Для быстрого просмотра результатов по отдельным чипам можно также использовать SportiduinoPQ. Для этого поднести чип к станции и во вкладке Card нажать Read Chip. Результат отобразится в логе.