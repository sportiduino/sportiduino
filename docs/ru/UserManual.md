# Руководство пользователя

Данная инструкция имеет общий характер и предназначена для пользователей системы отметки.
Более подробная информация по устройству,
а также инструкции по сборке находится на странице https://github.com/sportiduino/sportiduino/


* [Общая информация](#общая-информация)
* [Инструкция для участников](#инструкция-для-участников)
* [Инструкция для организатора](#инструкция-для-организатора)
    * [Подключение мастер-станции](#подключение-мастер-станции)
    * [Подготовка чипов участников](#подготовка-чипов-участников)
    * [Чтение чипов и формирование результатов](#чтение-чипов-и-формирование-результатов)
    * [Подготовка базовых станций](#подготовка-базовых-станций)
    * [Настройка мастер-станции](#настройка-мастер-станции)


## Общая информация

### Чипы

Поддерживаемые типы чипов:
- [Mifare Ultralight C](http://www.nxp.com/documents/data_sheet/MF0ICU2.pdf) на 36 отметок
- [Mifare Classic 1K](https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf) на 42 отметки
- [Mifare Classic 4K](https://www.nxp.com/docs/en/data-sheet/MF1S70YYX_V1.pdf) на 90 отметок
- [NTAG213/215/216](https://www.nxp.com/docs/en/data-sheet/NTAG213_215_216.pdf) на 32/120/216 отметок

Данные типы чипов производятся в разном форм-факторе.
Рекомендуются для использования чипы NTAG как более ёмкие.

### Базовые станции

Базовая станция представляет собой электронное изделие в небольшом корпусе с фланцами.
Вес одной станции от 100 до 150 грамм.
Питание от литий-полимерного аккумулятора 900 мАч.
В старых версиях питание от 3 батареек АА, в зависимости от режима работы батареек хватает от 45 дней до 2 лет.
Кнопок и другого интерфейса на станции нет.
Весь обмен информацией и запись чипов происходит в бесконтактном режиме
по стандарту бесконтактных пассивных карт ближнего радиуса действия ISO 14443A.
Оптимальная зона срабатывания 0,5 — 2 см над станцией.

![](/img/BaseStation1.jpg?raw=true)

В станции установлена микросхема часов реального времени, обладающая малой погрешностью хода,
но станции не являются прибором точного времени, время нужно регулярно корректировать.

Для обеспечения более длительной работы от батареи базовые станции могут работать в трех режимах:

* **Спящий режим.**
Для хранения станций между соревнованиями.
Опрос чипа происходит раз в 25 секунд. Практически не потребляют энергию.
Батарей AA хватит более чем на 2 года.
Для перевода в данный режим используются специально записанные мастер-чипы.
Вывод осуществляется прикладыванием любого чипа или чипа с магнитом для мгновенного срабатывания.
Магнит при этом нужно прикладывать к середине левого края лицевой стороны станции.
Также при выводе из сна происходит очистка внутренней памяти.
* **Режим ожидания.**
Опрос чипа раз в 1 секунду. Батарей хватит примерно на полгода.
* **Рабочий режим.**
Опрос чипа раз в 0,25 секунд. Самый быстрый режим отметки. Батарей AA хватит на 45 дней.

Базовые станции в зависимости от заданного им номера (от 1 до 255) могут выполнять разные функции:

- **Обычные станции отметки** с номерами 1 - 239.
При поднесении чипа записывают в него отметку и подают сигнал.
При повторном поднесении чипа не производят запись, подают двойной сигнал.
- **Станция старта (номер 240)**.
В режиме проверки станцией старта/финиша не производят отметку и не сигналят, если чип не пустой.
В обычном режиме записывает отметку как обычные базовые станции.
- **Станция финиша (номер 245)**.
Записывает отметку как обычная базовая станция.
- **Станция проверки (номер 248)**.
Если чип пустой и время его инициализации/очистки не отстает более чем на месяц от текущего, станция подаёт одиночный сигнал, иначе – молчит.
Станция ничего не записывает на чип и работает по скорости как обычная, так что на ней участники могут потренироваться в отметке перед стартом.
- **Станция очистки (номер 249)**.
Стирает все данные на чипе, оставляя неизменным номер, а также обновляет время инициализации на чипе.
При поднесении чипа загорается светодиод и мигает все время процедуры очистки, звуковой сигнал говорит об успешности процедуры.

### Мастер-станция

Также называется станцией сопряжения или станцией считывания.
Это станция с разъемом mini USB для подключения к компьютеру.
Нужна для настройки базовых станций, записи и считывания чипов.

![](/img/MasterStation1.jpg?raw=true)

## Инструкция для участников

С данной инструкцией очень желательно ознакомить участников до начала соревнований.

* Для отметки нужно поднести чип примерно к центру цветного круга на лицевой стороне станции.
* В случае успешной отметки станция издаст звуковой сигнал и мигнет один раз светодиодом.
* Оптимальный диапазон срабатывания 0,5 — 2 см. 
* Если чип далеко от станции, отметка может сработать не с первого раза.
* При отметке не нужно двигать чип из стороны в сторону, это затрудняет чтение и запись чипа.
* Если не получилось отметиться, уберите чип и вновь поднесите его к центру цветного круга на станции.
* Время отметки составляет от 0,06 до 0,4 секунды, если станция находится в рабочем режиме.
* Если Вы пришли на контрольный пункт первым, её, возможно, нужно разбудить, время отметки в таком случае составит до 1,2 секунды.
* При попытке повторной отметки станция издаст два коротких сигнала без записи новой отметки.
Если не уверены, отметились ли вы с первого раза, стоит повторить.
* Если вы пришли на КП одновременно с другим участником, то отмечаться нужно по очереди.
Нельзя одновременно приложить к станции отметки два и более чипа, в этом случае отметка будет записана только на один из чипов.

## Инструкция для организатора

Для работы со станциями необходимо использовать программы:
* [SportiduinoPQ](https://github.com/sportiduino/SportiduinoPQ/releases) для подготовки чипов участников и настройки станций;
* [SportiduinoApp](https://github.com/sportiduino/SportiduinoApp/releases) для тех же целей на Android-смартфоне с NFC;
* [SportOrgPlus](https://github.com/sembruk/sportorg-plus/blob/master/docs/index.md) для чтения чипов и подсчёта результатов соревнований.

Программу SportiduinoPQ можно скачать [на странице](https://github.com/sportiduino/SportiduinoPQ/releases).
В релизе присутствует портативный исполняемый EXE файл для Windows, не требующий установки.
При работе программы весь лог сохраняется в подпапку log.

Программа SportOrgPlus является адаптацией [SportOrg](https://sportorg.readthedocs.io/ru/latest/),
и предназначена для подсчёта результатов соревнований как по ориентированию, так и по рогейну.

*Далее описана процедура работы со станциями и чипами с момощью программы SportiduinoPQ.*

### Подключение мастер-станции

_Перед первым подключением мастер-станции в ОС Windows нужно поставить драйвер.
[Установщик драйвера](http://wiki.amperka.ru/_media/articles:driver-ch340:ch340ser-wimdows.zip) для станции на микросхеме CH340._

Подключить мастер-станцию по USB.
Запустить программу SportiduinoPQ.

Для подключения станции нужно нажать кнопку `Подключить` (`Connect`).

![](/img/pq_ru_connect1.png?raw=true)

Если подключение удалось, в логе отобразится `Подключена станция сопряжения <...>`, станция подаст звуковой сигнал.

![](/img/pq_ru_connected.png?raw=true)

Если подключить станцию не удаётся, проверьте правильность соединения.
Проблемы могут возникнуть, если в системе есть другое подобное устройство, не являющееся станцией.
В таком случае нужно через Диспетчер устройств в Панели управления Windows выяснить номер Com порта, присваиваемый станции и выбрать его вместо "авто".
Также для станции на Arduino Nano с чипом CHG340 необходимо установить соответствующий драйвер.

### Подготовка чипов участников

Пустые чипы необходимо инициализировать (записать на них номер и текущее время).
Для этого во вкладке `Осн` (`Main`) надо ввести номер чипа в поле `Чип №`.
Далее поднести чип к станции и нажать кнопку `Подготовить чип` (`Init Card`).
Процесс инициализации занимает в зависимости от чипа от 3 до 7 секунд.
В случае успеха станция издаст один сигнал.
Если стоит галочка `Автоувеличение` (`Autoincrement`), то число в поле ввода увеличится на 1.
Если процесс прошел неудачно (несколько коротких сигнала), попробуйте повторить процедуру.

![](/img/pq_ru_card_init.png?raw=true)

Номер чипа можно задать в диапазоне от 1 до 65535.

При инициализации помимо номера чипа записывается время инициализации,
которое необходимо для последующего считывания чипа.
Если с момента инициализации или очистки прошло более полугода, данные будут некорректными.
Поэтому желательно инициализировать чипы незадолго до соревнований.

Уже ранее инициализированные чипы можно очистить с сохранением номера на станции очистки.

### Чтение чипов и формирование результатов

Для чтения чипов и формирования результатов рекомендуется использовать программы SportOrgPlus или SportOrg.

Для быстрого просмотра результатов по отдельным чипам можно также использовать SportiduinoPQ.
Для этого поднести чип к станции и во вкладке `Осн` (`Main`) нажать `Прочитать чип` (`Read Card`).
Результат отобразится в окне лога.

![](/img/pq_ru_read_card.png?raw=true)

### Подготовка базовых станций

Краткий порядок действий для подготовки станции к соревнованиям:

1. Разбудить станцию.
1. Наклеить стикер с номером, записать номер на станции, если ещё не записан.
1. Настроить время на станции, если оно не настроено или настраивалось давно.
1. Считать состояние станции для проверки заряда батареи (опционально).
1. Отправить станции в сон с временем пробуждения перед стартом первых участников.

#### Пробуждение станции

Для настройки станций, если они находится в состоянии сна, необходимо их сначала разбудить.
Для моментального пробуждения станции нужно приложить чип с магнитом.
Если такого нет, нужно приложить любой чип участника на время до 30 секунд.
При пробуждении загорится светодиод на 3 секунды,
после чего станция подаст длинный сигнал (батарея в норме) или серию коротких (необходимо зарядить).

![](/img/station_wakeup.jpg?raw=true)

#### Мастер-чипы

Станции настраиваются с помощью так называемых мастер-чипов.
Мастер-чип – это чип с записанными на него настройками или командами для передачи их на базовую станцию.
Чтобы записать мастер-чип, нужно поднести его к мастер-станции и нажать нужную кнопку на вкладке `Чип` (`Card`) в зависимости от задачи.
Рекомендуется отобрать несколько чипов для использования в качестве мастер-чипов и пометить их,
чтобы избежать их смешивания с чипами участников или использовать чипы другого цвета или форм-фактора.

Перед подготовкой мастер-чипов установите текущий пароль в программе SportduinoPQ.
После сборки станции имеют пароль по умолчанию 0,0,0.
Если вы не правильно установите пароль, то базовая станция не примет настройки с мастер-чипа.

Введённый пароль сохраняется между сеансами работы SportduinoPQ,
таким образом для работы с одним комплектом станций пароль понадобиться указать только один раз.

![](/img/pq_ru_password1.png?raw=true)

#### Присвоение номера станции

В программе SportiduinoPQ на вкладке `Чип` (`Card`) указать номер станции (от 1 до 239),
поднести чип к мастер-станции и нажать кнопку `Создать`.
После чего данный чип поднести к станции.
Станция издаст один длинный сигнал подтверждения. 

Для задания специальных станций выделены отдельные кнопки.

![](/img/pq_ru_master_num.png?raw=true)

#### Настройка времени станции

Для настройки времени нужно приложить любой чип к мастер-станции и нажать `Создать` (`Create`) в разделе `Мастер-чип "Часы"` (`Date/Time Card`) на вкладке `Чип` (`Card`).

![](/img/pq_ru_master_time.png?raw=true)

Станция подаст четыре сигнала с интервалом в секунду.
После третьего сигнала нужно приложить чип к базовой станции.
При этом станция издаст длинный сигнал.
Если последний сигнал мастер станции и сигнал базовой станции слились в один, то время настроено достаточно точно.
Настройку времени лучше проводить в активном режиме станции в виду более короткого периода опроса чипов.

*Погрешность хода часов составляет порядка 1 секунды в неделю.
Для критически важных станций старта и финиша рекомендуется обновлять время в день соревнований.*

#### Перевод станций в спящий режим

После соревнований нужно перевести все станции в спящий режим для продления работы от батарей.
Для этого нужно поднести чип к мастер-станции.
В программе SportiduinoPQ на вкладке `Чип` (`Card`) нажать `Создать` в разделе `Мастер-чип "Сон"` (`Sleep Card`).
Затем поднести созданный мастер-чип к базовой станции.
Станция подаст 4 сигнала, и войдёт в спящий режим.

![](/img/pq_ru_master_sleep.png?raw=true)

При создании мастер-чипа для перевода базовой станции в режим сна,
вы можете указать дату автоматического пробуждения станции в поле `Время пробуждения`.
В это время базовая станция автоматически перейдёт в активный режим и отметка у первого участника сработает быстрее.
Если вы хотите перевести базовые станции в режим сна для хранения, то укажите любую прошедшую дату и время.

#### Изменение пароля

Использование паролей защищает станции от возможности несанкционированного их перепрограммирования.
После сборки пароль по умолчанию 0, 0, 0.

![](/img/pq_ru_master_password.png?raw=true)

**ВНИМАНИЕ!**
*Если вы установите новый пароль и забудете его, то для сброса пароля понадобится разборка станции и обновление настроек по UART.
Рекомендуется сохранить пароль в надёжном месте.*

#### Другие настройки базовой станции

Продолжительность активного режима, дополнительные проверки и усиление антенны базовой станции можно задать на вкладке `Конф.` (`Config`),
и записать на станцию с помощью мастер-чипа.

![](/img/pq_ru_master_config.png?raw=true)

Настройки подробнее:
- `Актив. время (ч)` — время работы в активном режиме (1, 2, 4, 8, 16, 32, "никогда" или "всегда").
Если в течение этого времени на станции никто не отметится, то станция перейдёт в режим ожидания (не в сон).
Если указано "никогда", станция находится в режиме ожидания с опросом 1 секунда и не переходи в активный режим.
Если указано "всегда", станция находится в активном режиме и самостоятельно не переходит в режим ожидания или сна.
- `Старт как Проверка` — включает проверку на станции старта отсутствие отметок в чипе.
Если отметки есть (чип не очищен), станция не отмечает старт и не подаёт сигнал.
- `Пров. вр. чипа` — включает проверку времени инициализации чипа участника.
Если после инициализации чипа прошло больше 31 дня, станция не делает отметку и не подаёт сигнал.
- `Автосон` — включает переход станции в режим сна через 48 часов после последней отметки.
- `Быст. отметка` — включает запись метки быстрой отметки в чип на станции очистки.
- `Усил. антенны` — коэффициент усиления антенны модуля MFRC522.

Мощность антенны по умолчанию 33 дБ.
Если задать максимальную мощность, то в некоторых станциях чипы перестают отмечаться при поднесении их вплотную.
Для станций с этой проблемой нужно постепенно уменьшать мощность до достижения оптимального срабатывания.

#### Снятие лога станции

В ходе работы базовая станция ведет лог – записывает номера чипов и время отметки.
С использованием этой функции возможно восстановление данных в случае утери чипов, проверки спорных ситуаций, а также в поиске сошедших или потерявшихся участников.

Для снятия лога нужно записать мастер-чип.
Для этого поднести чип к мастер станции и в программе SportiduinoPQ нажать `Создать` в разделе `Мастер-чир "Лог отм."` (`Dump Card`) на вкладке `Чип` (`Card`).
После чего поднести мастер чип к базовой станции.
Процесс займёт до 10 сек, нужно неподвижно держать чип в оптимальной области записи (0.5 - 2 см над центром круга антенны).
После успешного снятия лога поднести чип к мастер-станции и нажать `Читать` в разделе `Мастер-чир "Лог отм."` (`Dump Card`).
Результат появится в логе программы.

![](/img/pq_ru_master_backup.png?raw=true)

#### Чтение состояния станции

Чтобы проверить настройки базовой станции, уровень заряда батареи, время и текущий режим её работы,
создайте в программе SportiduinoPQ мастер-чип для чтения состояния станции.

Для этого во вкладке `Чип` (`Card`) нажмите `Создать` в разделе `Мастер-чип Состояние` (`State Card`).
После этого поднесите созданный мастер-чип к базовой станции.
Если базовая станция находится в режиме сна, то нужно будет подождать в течение 30 секунд (или использовать чип с магнитом).
Базовая станция включит светодиод на 3 секунды и издаст одиночный звуковой сигнал, после чего мастер-чип следует убрать.
Если базовая станция находилась в режиме сна, то она в нём останется, её не нужно переводить заново в режим сна.
Если в течение 30 секунд базовая станция не реагирует на чип, то либо она неисправна, либо батарея разряжена, либо следует пересоздать мастер-чип.
После того как базовая станция записала информацию на мастер-чип, приложите мастер-чип к станции сопряжения и в программе SportidunoPQ нажмите `Читать` в том же разделе.
После этого в логе отобразится вся информация о базовой станции.
Также изменятся значения полей во всех вкладках SportiduinoPQ в соответствии с текущими настройками базовой станции.

![](/img/pq_ru_master_state.png?raw=true)

#### Быстрая подготовка базовой станции

До того, как базовая станция закрыта в корпусе возможна быстрая подготовка станции по UART с использованием преобразователя USB-to-TTL.

![](/img/ProgrammerWire.jpg?raw=true)

Подключите преобразователь к разъёму Prog базовой станции (без подключения DTR).

Не имеет значение находится станция в активном режиме или режиме сна.
Если станция спит, то будить её не надо.
В программе SportduinoPQ во вкладке `Конф.` (`Config`) в разделе `Настройка по UART` (`Config by UART`)
установите номер Com-порта преобразователя USB-to-TTL и нажмите кнопку `Записать` (`Write`).
При этом в базовую станцию будет записано текущее время и все остальные настройки.

![](/img/pq_ru_config_uart.png?raw=true)

Чтобы убедиться, что настройки записались правильно нажмите на кнопку `Читать` (`Read`).
После чего на экране появятся текущие настройки станции. При этом режим станции не изменится.

![](/img/pq_ru_config_uart2.png?raw=true)

### Настройка мастер-станции

Во вкладке `МС` (`MS`) доступны для изменения следующие опции:
* `Усил. антенны` — усиление антенны RFID модуля станции; значение по умолчанию 33 дБ;
* `Часовой пояс` — необходимо указать часовой пояс для корректной работы мастер-станции в режиме эмуляции SPORTident (например, с программой Winorient).

![](/img/pq_ru_ms_tab.png?raw=true)

