# Чипы отметки

Система отметки поддерживает следующие типы чипов:
- [Mifare Ultralight C](http://www.nxp.com/documents/data_sheet/MF0ICU2.pdf) на 36 отметок
- [Mifare Classic 1K](https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf) на 42 отметки
- [Mifare Classic 4K](https://www.nxp.com/docs/en/data-sheet/MF1S70YYX_V1.pdf) на 90 отметок
- [NTAG213/215/216](https://www.nxp.com/docs/en/data-sheet/NTAG213_215_216.pdf) на 32/120/216 отметок

Тип используемых чипов система определяет автоматически и может одновременно работать с разными типами чипов.

Рекомендуется использовать чипы NTAG213/215/216.

![](/img/chip.jpg?raw=true "Чипы в виде брелков")

**Важно!** Для надежной работы с данными чипами, которые обладают небольшой по площади антенной,
необходимо заменить индуктивности на более мощные в плате RFID RC522 (см. [Сборка станции отметки](BaseStationAssembly.md)).

Чипы Mifare Classic 1K идут в комплекте с модулем RC522.
Памяти данных чипов хватает на 42 отметки. Работают чуть медленнее NTAG.
Память чипов Mifare используется лишь на четверть, так как в их структуре реализованы страницы длиной 16 байт.
И при более плотной записи есть риск потери данных. Структура записи аналогичная NTAG.

Память чипов NTAG213/215/216 разделена структурно на 45/135/231 страниц, в каждой из которых содержится по 4 байта.
В первых 4-х страницах содержится UID и другая служебная информация.
Также служебная информация содержится в последних 5 страницах.
Таким образом, для записи остается 36/126/222 страниц.

### Структура данных

Страницы 4-7 зарезервированы, остальные страницы для отметки.
В 4-й странице в первых двух байтах содержится программируемый номер чипа.
В 4-м байте версия прошивки (8 для v3.8.0, 9 для v3.9.1 и т. д.).
В пятой странице время инициализации чипа в формате Unixtime
С помощью него восстанавливается первый байт времени в отметки.
Далее две страницы резерва для реализации дополнительных функций на отдельных стартах.
Запись отметки на станции занимает отдельную страницу,
в первый байт которой записывается номер станции, в остальные три байта - младшие байты текущего времени в Unixtime.

<img src="/img/ntag.png" width="690">

У мастер-чипов для программирования станций структура отличается.
Станция определяет их по числу 255, записанному в третий байт 4-й страницы.
Существует 8 разных мастер-чипов: времени, номера, сна, настроек, пароля, пароля аутентификации, лога и состояния.
Ниже представлена структура мастер-чипов.

![](/img/master-card1-ru.png?raw=true)

![](/img/master-card2-ru.png?raw=true)

#### Мастер-чип установки времени на станции

Записывает дату и время в станцию (в часы реального времени).

Данный чип однократного действия. 
То есть после считывания информации с чипа на нём стирается страница 4
для предотвращения случайного повторного его использования.

#### Мастер-чип установки номера на станции

Записывает номер в станцию, если он больше 0.

Данный чип однократного действия. 

#### Мастер-чип перевода в спящий режим

Записывает в станцию дату и время пробуждения и переводит её в режим сна.
При пробуждении по таймеру станция переходит в активный режим.

Данный чип многократного действия. 

#### Мастер-чип установки настроек

Записывает номер (если > 0), байт настроек, усиление антенны (если ≥ 2 и ≤ 7) и новый пароль в станцию.

Данный чип многократного действия. 

#### Мастер-чип установки пароля

Записывает новый пароль в станцию.

Данный чип многократного действия. 

#### Мастер-чип установки пароля аутентификации

Записывает пароль аутентификации (4 байта) чипов Ntag в станцию.

Данный чип многократного действия.

#### Мастер-чип получения лога

В данный чип станция записывает лог отметок.
Если станция сохраняет лог с временными метками, то записывается лог за последние 12 дней в порядке возрастания номеров чипов.
Так как ёмкости чипа может быть недостаточно для записи всего лога с временными метками,
то для полного считывания лога необходимо несколько раз приложить чип к станции с промежуточным считыванием содержимого чипа.

Данный чип многократного действия. 

#### Мастер-чип чтения состояния станции

В данный чип станция записывает:
- номер версии прошивки (3 байта) в страницу 4;
- номер станции, байт настроек, усиление антенны в страницу 5;
- напряжение батареи (мВ/20, 1 байт) и режим (1 байт) в страницу 6;
- текущее время в формате Unix в страницу 7;
- время пробуждения в формате Unix в страницу 8;

Данный чип многократного действия. 

