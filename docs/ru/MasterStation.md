# Станция сопряжения

Станция сопряжения может быть выполнена в различных корпусах.

![](/img/MasterStation1.jpg?raw=true "Станция сопряжения в корпусе, распечатанном на 3D-принтере")

или

![](/img/w06.jpg?raw=true "Станция сопряжения в корпусе G1020BF")

Схема и плата доступны в Upverter ([вариант 1](https://upverter.com/AlexanderVolikov/3fc0efdb2586988d/Sportiduino-reading-stantion/) и
[вариант 2](https://upverter.com/design/syakimov/4f7ec0e2d3b9c4e9/sportiduino-master-station/)).

![](/hardware/MasterStation/usb/sportiduino-master-scheme.png?raw=true "Принципиальная схема")

Все компоненты схемы можно разместить на печатной плате или припаять к Arduino навесным монтажом обычными проводами (рекомендуется провод МГТФ-0,12).
Электронику мастер-станции можно разместить в корпусе Gainta G1020BF или в специально разработанном корпусе, который можно распечатать на 3D-принтере.
[Подробнее про сборку](MasterStationAssembly.md).

Станция подключается к компьютеру с помощью USB соединения.
В Arduino Nano уже встроен Serial-USB преобразователь, поэтому дополнительных конвертеров не нужно.
Станция отобразится в подключенных устройствах как COM-порт. 

### Протокол передачи данных

Передача и получение информации происходит последовательно с помощью передачи пакетов длиной до 32 байт.
Если размер передаваемых данных больше 28 байт, то данные передаются в нескольких пакетах.

| | Значение | Адрес байта в пакете |
| --- | --- | --- |
| Старт | 0xFE | 0 |
| Функция | | 1 |
| Длина данных или номер пакета+0x1E, если пакетов несколько | | 2 |
| Массив данных | | 3 … x (x<31) |
| Контрольная сумма | | x+1 |

Пакет начинается со стартового байта 0xFE.

Команда задается байтом с адресом 1.
Затем в байте 2 следует длина пакета, если передаваемый пакет последний либо его номер+30, если идёт многопакетная передача.

Далее идёт массив передаваемых данных до 28 байтов.

В конце пакета содержится контрольная сумма: остаток от деления на 256 суммы байтов 1 … x.
В случае неверного значения стартового байта или контрольной суммы пакет отбрасывается.

#### Список команд, передаваемых на станцию

| Код | Команда | Длина | Массив данных по байтам (в скобах адрес в массиве) |
| --- | --- | --- | --- |
| 0x41 | Записать время на мастер-чип | 6 | год-2000(0), месяц(1), день(2), час(3), минута(4), секунда(5)
| 0x42 | Записать номер станции на мастер-чип | 1 | номер(0)
| 0x44 | Инициализировать чип | 14 | номер чипа (0-1), текущее время (2-5), информация в 6-7 страницы (6-13)
| 0x45 | Передать параметры страниц 6 и 7 | 8 | информация в 6-7 страницы (0-7)
| 0x46 | Запрос версии прошивки мастер-станции | 0 |
| 0x47 | Записать мастер-чип лога | 0 |
| 0x48 | Считать мастер-чип лога | 0 |
| 0x4A | Записать настройки станции сопряжения | 1 | усиление антенны(0)
| 0x4B | Считать чип | 0 |
| 0x4C | Считать сырые данные с чипа | 0 |
| 0x4D | Считать настройки станции сопряжения | 0 |
| 0x4E | Записать мастер-чип сна | 6 | год-2000(0), месяц(1), день(2), час(3), минута(4), секунда(5)
| 0x4F | Установить текущий пароль | 3 | пароль (0-2)
| 0x50 | Создать мастер-чип для чтения состояния станции | 0 |
| 0x51 | Считать тип чипа | 0 |
| 0x58 | Сигнал ошибки (три коротких) | 0 |
| 0x59 | Сигнал ОК (длинный) | 0 |
| 0x5A | Записать настройки на мастер-чип | 6 | конфигурация станции

#### Список ответов от станции

| Код | Ответ | Длина | Массив данных по байтам (в скобах адрес в массиве) |
| --- | --- | --- | --- |
| 0x61 | Лог | N пакетов | (первый пакет - номер станции (0)), номер отметившегося чипа 1(1-2), номер отметившегося чипа 2(3-4) и т. д.
| 0x63 | Данные с чипа отметки | N пакетов | (первый пакет - номер чипа (0-1), информация в 6-7 страницах чипа (2-9)), номер КП0 (10), время КП0 (11-14), номер КП1 (15), время КП1 (16-19) и т. д.
| 0x65 | Сырые данные с чипа | N пакетов | номер страницы 4(0), байты страницы 4(1-4), номер страницы 5(5), байты страницы 5(6-9) и т. д.
| 0x66 | Версия прошивки мастер-станции | 3 | версия прошивки(0-2)
| 0x67 | Настройки мастер-станции | 1 | усиление антенны(0)
| 0x70 | Тип чипа | 1 | тип чипа(0)
| 0x78 | Ошибка | 2 | код ошибки(0), тип чипа (1)
| 0x79 | ОК | 1 | тип чипа (0)

#### Коды ошибок

| Код | Ошибка |
| --- | --- |
| 0x01 | Ошибка передачи данных через COM-порт
| 0x02 | Ошибка записи чипа
| 0x03 | Ошибка чтения чипа
| 0x04 | Ошибка чтения EEPROM
| 0x05 | Чип не найден
| 0x06 | Неизвестная команда

### Эмуляция протокола SPORTident

В прошивке станции сопряжения начиная с версии 1.8.0 реализовано чтение чипов по протоколу передачи данных системы отметки SPORTident.
Все чипы определяются как SI-Card 6 (192 отметки).
Проверялась работа станции сопряжения с программами SPORTident Reader, Rogain Manager, SportOrg, MeOS 3.8.1277, WinOrient 2.0a (2011 - 2020).

