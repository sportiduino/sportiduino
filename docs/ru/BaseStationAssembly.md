# Сборка станции отметки

*Данная инструкция для сборки станции версии 3 с питанием от 3-х элеметнов АА в корпусе Gainta G1020BF.*

[Сборка станции отметки v2](https://github.com/sportiduino/sportiduino/blob/v2.6.3/Doc/ru/BaseStationAssembly.md)

[Сборка станции отметки v1](https://github.com/sportiduino/sportiduino/blob/1.3.7/Doc/ru/BaseStationAssembly.md)


### Компоненты станции отметки

![](/img/s01.jpg?raw=true)

1. RFID-модуль RC522.
2. Печатная плата. Можно заказать через [EasyEDA](https://easyeda.com/order) или [JLCPCB](https://jlcpcb.com/).
Gerber файлы находятся в папке `hardware/BaseStation/prod/v3`. *На фото представлена печатная плата версии 1.*
3. Микросхемы
   - Микроконтроллер ATmega328P-AU 
   - Часы DS3231SN 
   - Память 24LC256T-I/SN (опционально, нет на фото)
   - Стабилизатор напряжения MCP1700T-33. 
   - Транзистор BSS138 в корпусе SOT-23.
4. Пассивные компоненты в формате 0805. 
   - Резистор 100 Ом, 1 шт.
   - Резистор 3,3 кОм, 2 шт.
   - Резистор 10 кОм, 2 шт.
   - Резистор 33 кОм, 2 шт.
   - Резистор 68 кОм, 1 шт.
   - Резистор 270 кОм, 1 шт.
   - Конденсатор 0,1 мкФ, 7 шт.
   - Конденсатор 4,7 мкФ, 2 шт.
   - Индуктивность 2,2 мкГн, ток насыщения > 500 mA (например, LQH32MN2R2K), 2 шт, опционально.
5. Выводные компоненты
   - Разъём 8 контактов PLS-8 на плату ("гребёнка"). Идёт в комплекте с RFID-платой.
   - Разъём 10 контактов BH-10 (DS1013-10S или IDC-10MS). Можно заменить любой вилкой на плату 2x5 с шагом 2,54 мм.
   - Разъём 2 контакта JST XH с шагом 2,54 мм, вилка на плату.
   - Светодиод 3 мм.
   - Пассивный зуммер 12085 16 Ом, TR1205Y или HCM1203A.
   - Геркон замыкающий 2x14 мм (опционально, нет на фото).
6. Батарейный отсек 3xAA или 3xAAA (тогда корпус будет закрываться проще).
7. Корпус Gainta G1020BF.


Оборудование, которое пригодится при сборке, приведено [на отдельной странице](Equipment.md).

### Подготовка RFID-модуля

У модуля необходимо выпаять светодиод D1 и резисторы R1 и R2,
иначе потребление тока во время его работы будет выше.

Также рекомендуется заменить индуктивности L1 и L2 на аналогичные 2,2 мкГн,
но с большим рабочим током для увеличения мощности антенны. Например, Murata LQH32MN2R2K (Спасибо за совет Александру Якимову).

![](/img/s12_1.JPG?raw=true)

### Пайка основной платы

![](/hardware/BaseStation/prod/v3/sportiduino-base-v3-scheme.png?raw=true "Принципиальная схема")

![](/img/pcbv3-build-instructions.png?raw=true "Расположение компонентов")

Обильно промазываем флюсом все места будущей пайки.
Далее припаиваем микросхемы.
После микросхем припаиваем транзистор, стабилизатор напряжения, резисторы и конденсаторы.
Резистор R8 и конденсатор C8 можно не припаивать, так как они сейчас не используются и зарезервирован для будущих версий.
Контактные площадки JP1 и JP2 замыкаем каплей припоя или перемычками, как показано на принципиальной схеме (контакты 1 и 2).
В конце припаиваем светодиод, зуммер, "гребёнку" и батарейный отсек.
Светодиод припаиваем с обратной стороны платы.
Вместо выводного светодиода можно припаять SMD-светодиод от RFID-модуля.
Модуль RC-522 пока не припаиваем.

**Внимание!** Не перепутайте при пайке полярность у светодиода и зуммера.

### Программатор

Для загрузки на микроконтроллер bootloader потребуется программатор.
Если у вас нет программатора, то его можно сделать из Arduino Nano.

#### Программатор из Arduino Nano

Для его изготовления потребуется шлейф на 10 проводов длиной 25 см и разъём IDC-10F (DS1016-10).
Вместо этого разъёма можно использовать любой другой типа розетка 2x5 с шагом 2,54 мм.

На конце шлейфа устанавливается разъём.
Другой конец шлейфа припаиваем к плате Arduino Nano в соответствии со схемой.
При этом пока не устанавливаем конденсатор 10 мкФ 16В.

![](/img/ArduinoNanoIspScheme.png?raw=true "Схема программатора из Arduino Nano")

Далее подключаем Arduino Nano к ПК через USB и запускаем Arduino IDE.
Открываем скетч ArduinoISP из примеров Arduino (Файл->Примеры->ArduinoISP).
Далее в меню `Инструменты` выбираем плату `Arduino Nano`, процессор `ATmega328P (Old Bootloader)` и соответствующий порт.

![](/img/ArduinoIspScr1.jpg?raw=true)

Выполняем Скетч->Загрузка.
После этого припаиваем конденсатор на 10 мкФ 16В между GND и RST как на схеме выше.
Если не припаять конденсатор, то при программировании постоянно будет появляться сообщение об ошибке:
`avrdude: stk500_getsync() attempt 1 of 10: not in sync: resp=0x15`.
Программатор готов.

![](/img/ArduinoNanoISP.jpg?raw=true "Программатор из Arduino Nano")

### Преобразователь USB-UART

Для загрузки на микроконтроллер основной прошивки потребуется USB-UART преобразователь.
У преобразователя обязательно должен быть сигнал DTR.
Для его подключения к плате станции также нужен шлейф на 10 проводов и разъём IDC-10F.

![](/img/SerialProgrammer.png?raw=true "Схема подключения USB-UART")

Если помимо загрузки прошивки преобразователь будет использоваться также для настройки станции и для чтения её состояния,
то при подключении шлейфа к преобразователю нужно предусмотреть возможность отключения проводника от вывода DTR.

![](/img/ProgrammerWire.jpg?raw=true "Преобразователь USB-UART")

### Прошивка микроконтроллера

Выполняем предварительную [настройку Arduino IDE](ArduinoIde.md).

В Arduino IDE открываем скетч BaseStation (Файл->Папка со скетчами->BaseStation).
В меню Инструменты->Плата устанавливаем `Sportiduino Base Station`.
Далее в меню Инструменты->Программатор выбираем `Arduino as ISP`. 

![](/img/ArduinoIdeBoardSelection.png?raw=true)

Рекомендуется выбрать загрузчик "Optiboot 19200 with LED" в меню Инструменты.

Если на плате установлен активный зуммер, то выбираем "Buzzer frequency: 0 kHz (active buzzer)" в меню Инструменты->Программатор.

Подключаем наш программатор к плате Sportiduino.
Вставляем батарейки.

![](/img/ProgrammerConnect.jpg?raw=true "Подключение программатора")

Выполняем Инструменты->Записать загрузчик.
Если появилось сообщение об ошибке в логе, то проверяем сборку программатора и его подключение к плате, проверяем сборку самой платы.
Если всё прошло успешно, то отключаем программатор.

Подключаем преобразователь USB-UART.

![](/img/SerialProgConnect.jpg?raw=true "Подключение преобразователя USB-UART")

Выполняем Скетч->Загрузить.
После завершения загрузки станция должна подать три коротких сигнала и через 3 секунды один длинный.
Если этого не произошло, то необходимо проверить пайку платы.

### Пайка RFID-модуля и проверка

После прошивки микроконтроллера припаиваем RFID-модуль и геркон (опционально) к нашей плате.

![](/img/BaseStationRfidSolded.jpg?raw=true "Плата с припаянным RFID-модулем и герконом") 

Затем проверяем работу станции.
Предварительно стоит записать мастер-чипы номера станции, времени и несколько обычных чипов.
После подачи питания станция подаст три коротких сигнала, что говорит о том, что часы не выставлены.
Затем через несколько секунд будет длинный сигнал, сигнализирующий, что питание в норме и программа вошла в цикл работы.
По умолчанию станция работает в режиме ожидания и проверяет наличие чипа в рабочей зоне раз в секунду.
Приложите мастер-чип номера станции. Станция запишет новый номер и теперь уже способна реагировать на обычные чипы.
Далее необходимо настроить часы.
Подносим мастер-чип времени и после установки подносим второй обычный чип.
Считываем его на станции сопряжения и убеждаемся в корректной работе.

![](/img/BaseStationTestAssembly.jpg?raw=true "Проверка работы старции")

Для проверки работоспособности геркона нужно подготовить специальный чип,
который будет использоваться для быстрого пробуждения станций.
Для этого приклееваем магнит с краю чипа.

Усыпляем станцию чипом сна и пробуждаем чипом с магнитом.

![](/img/BaseStationTestReedSwitch.jpg?raw=true "Проверка работы геркона")

Если станция прошла проверку, то плату можно отмывать от остатков флюса, например, в ванне с изопропиловым спиртом или специальным средством (например, FluxOff).
Если плата не работает, то нужно проверить прежде всего пайку микросхем и соединение с RFID-модулем.

![](/img/BaseStationClean.jpg?raw=true "Готовая плата после отмывки")

### Установка в корпус

В корпусе сначала нужно просверлить отверстие для светодиода 3 мм.
Координаты отверстия показаны на рисунке ниже.
Чтобы влага не попадала внутрь через это отверстие,
его необходимо заклеить с обратной стороны скотчем, а с другой стороны залить термо- или эпоксидным клеем.

![](/img/BaseStationHole.jpg?raw=true "Положение отверстия")

Далее можно приклеить батарейный отсек к крышке корпуса.

После этого устанавливаем плату так, чтобы светодиод попадал в центр просверленного отверстия.

Закрепляем плату термоклеем.
*На фото плата версии 2.*

![](/img/BaseStationPcbGlue.jpg?raw=true "Закрепляем плату термоклеем")

![](/img/BaseStationPcbInBox.jpg?raw=true "Плата в корпусе")

После этого можно залить корпус компаундом.
Или можно обойтись и без него. Например, если промазать стык корпуса силиконовым герметиком или приклеить крышку к корпусу.

*На фотографиях ниже показана плата версии 1.*

![](/img/s26.jpg?raw=true)

На 1 станцию отмеряем 30 мл компаунда

![](/img/s27.jpg?raw=true)

и 1 мл отвердителя. Перемешиваем отвердитель с компаундом.

![](/img/s28.jpg?raw=true)

![](/img/s29.jpg?raw=true)

И заливаем нашу плату.
Должно получиться так, что все контакты залиты силиконом.
Выходят только разъём для программирования и зуммер.

![](/img/s30.jpg?raw=true)

![](/img/s31.jpg?raw=true)

Через сутки компаунд полностью затвердевает.
При этом все детали хорошо видно. В случае необходимости ремонта компаунд можно легко частично удалить.

![](/img/s32.jpg?raw=true)

Батарейный отсек промазываем вазелином или другим густым гидрофобным маслом и вставляем батарейки.

![](/img/s34.jpg?raw=true)

И закручиваем наш корпус. Детали лежат туго, может понадобиться небольшое усилие, чтобы закрыть корпус.

![](/img/s35.jpg?raw=true)

![](/img/s36.jpg?raw=true)

Печатаем на принтере наклейки из папки `hardware/BaseStation/2d`.
Наклейки выполнены в программе Inkscape.
Можно заказать печать наклеек на светоотражающей или светонакопительной плёнке.
Приклеиваем наклейку и сверху ламинируем её скотчем, если наклейка из простой бумаги.
Станция готова!

![](/img/BaseStation1.jpg)

![](/img/BaseStation2.jpg)

