# Станция отметки

### Варианты станции отметки

![](/img/bs_variants.jpg?raw=true "Варианты станции отметки")

#### Станция в корпусе G1020BF (номер 1 на рисунке)

Плата v1, v2, v3 или v3b.
Питание от 3-х батареек АА (ААА), либо литий-полимерного аккумулятора.
Если планируется использовать аккумулятор, то в корпус для плат v1-v3 необходимо установить и подключить плату зарядки
на микросхеме TP4056 (в версии v3b микросхема зарядки уже интегрирована в плату), а также разъём для зарядки 5.5х2.1.

#### Станция в оригинальном корпусе (номер 2 на рисунке)

Плата v3b.
Питание от литий-полимерного аккумулятора емкостью 800-950 мАч (например, 603443 или Robiton&nbsp;LP683440 900 мАч).
Разъём зарядки — 5.5х2.1.

[3D модель корпуса.](/hardware/BaseStation/box/sportiduino-base.FCStd)

Корпуса производятся методом литья в силиконовые формы.
Проверенный двухкомпонентный пластик для литья — Smooth-On&nbsp;TASK&nbsp;9.
Силикон для форм — Полидел&nbsp;MOLD&nbsp;S20.

#### Станция в китайском корпусе 85x58x33 (номер 3 на рисунке)

Плата v3b.
Питание от литий-полимерного аккумулятора емкостью 800-950 мАч (например, 603443 или Robiton&nbsp;LP683440 900 мАч).
Разъём зарядки — 5.5х2.1.
Рекомендуется заменить болты крепления крышки на нержавеющие (подойдут с резьбой М3, длиной 16 мм и диаметром шляпки не более 5,5 мм).

### Схема и монтаж

Основные компоненты станции отметки: микроконтроллер ATmega328P-AU, RFID-модуль RC522-mini или RC522, часы DS3231SN.
Питание через линейный стабилизатор MCP1700T-33.
Схема и плата выполнены в программе KiCad.

![](/hardware/BaseStation/prod/v3b/sportiduino-base-v3b-scheme.png?raw=true "Принципиальная схема платы v3b")

Монтаж компонентов производится на печатной плате, с платой RFID соединение пайкой через штыревой разъём.
Можно заказать изготовление плат в Китае. Например, на [JLCPCB](https://jlcpcb.com/).

![](/hardware/BaseStation/prod/v3b/sportiduino-base-v3b-pcb.png?raw=true "Расположение компонентов на плате v3b")

Для прошивки микроконтроллера потребуется Arduino с установленной прошивкой ArduinoAsIsp
или любой программатор для микроконтроллеров AVR, например, Pickit2.

Печатные платы и батарейный отсек размещаются в пластиковом корпусе.
Для защиты электроники от осадков и конденсата внутрь корпуса после сборки заливается компаунд.
Про сборку станции и прошивку более подробно написано в [Инструкции по сборке](BaseStationAssembly.md).

### Потребление

По умолчанию станция запускается в режиме ожидания.
При этом происходит считывание чипов раз в секунду.
Интегральное потребление до 0,5 мА.
Во время работы RFID потребляется до 20 мА (до 40 мА в момент считывания-записи).
Полностью заряженных батарей хватит примерно на 160 дней.

При поднесении чипа (это делает судья-постановщик или первый спортсмен) станция переходит в рабочий режим.
По умолчанию после 2 часов бездействия станция возвращается в режим ожидания.
Рабочее время задаётся с помощью настроек.

В рабочем режиме реализовано вхождение в сон каждые 250 мс.
Таким образом, во время работы можно ожидать интегральное потребление порядка 1,7 мА.
Полностью заряженных батарей хватит примерно на 45 дней непрерывной работы.

Для уменьшения потребления во время хранения станций реализован режим сна (Sleep mode).
В этом режиме станция потребляет около 15 мкА.
Полностью заряженных батарей хватит на 5 лет.

На плате RFID необходимо обязательно выпаять светодиод и подтягивающий резистор к линии RST, иначе потребление будет на порядки больше.

### Настройка

Настройка станции отметки производится мастер-чипами или через преобразователь USB-to-TTL.
См. [Руководство пользователя](UserManual.md).

### Алгоритм работы станции

После подачи питания или перезагрузки станция проверяет настройку часов.
Если часы настроены неправильно, то станция издаёт соответствующий сигнал.
Затем станция загружает из энергонезависимой памяти настройки (номер станции, пароль и др.).
Проверяется уровень заряда батареи (в это время на несколько секунд включается светодиод).
Если уровень заряда соответствует норме, станция издаёт один длинный сигнал. Если уровень низкий, то станция издаёт серию коротких (см. ниже).
После инициализации станция переходит в режим ожидания.
В режиме ожидания станция просыпается каждую секунду и ищет чип.
При обнаружении чипа переходит в рабочий режим с опросом чипа каждые 250 миллисекунд.
При поднесении чипа, станция считывает 1-й блок, где хранится номер чипа или признак мастер-чипа.
Если чип является обычным, то происходит поиск последней записанной страницы и считывание номера станции в последней отметке.
Если номер станции совпадает с последней отметкой, то станция издает двойной сигнал.
Если номер отличный, то производится запись отметки в блок следующий после записанного.
В случае успеха, станция подает одиночный сигнал, а также записывает факт отметки во внутреннюю энергонезависимую память станции (в бит, соответствующий номеру чипа).
Если на плате (v3 или v3b) установлена микросхема внешней энергонезависимой памяти EEPROM, в неё записывается отметка времени и номер чипа.
По умолчанию последняя отметка ищется методом бинарного поиска и его скорость зависит от максимального объема чипа.
Поиск и запись занимает для разного объема:

- 32 отметки - от 60 до 120 мс
- 64 отметки - от 60 до 140 мс
- 120 отметок - от 60 до 160 мс
- 220 отметок - от 60 до 180 мс

Также к этому времени добавляется период опроса.
То есть, в режиме ожидания добавляется от 0 до 1000 мс, в рабочем режиме от 0 до 250 мс.

Для ускорения записи отметки предусмотрен опциональный режим быстрой отметки.
В этом режиме номер последней отметки всегда записывается в 6-ю страницу чипа.
Таким образом не требуется длительный поиск последней страницы.
Но при этом сокращается время службы чипа, потому что 6-я страница чипа будет перезаписываться при каждой отметке.

На протяжении всего времени работы станции запущен сторожевой таймер, который при зависании системы её перезагружает.

### Настройки станции

С помощью мастер-чипа настроек можно задать:

- продолжительность рабочего режима;
- режим проверки на старте;
- режим проверки времени инициализации чипов;
- режим быстрой отметки;
- усиление антенны;
- пароль.

Во включенном режиме проверки на старте станция старта (номер 240) будет принимать только очищенные чипы.

По умолчанию все специальные режимы выключены, пароль — 0-0-0.

### Станция очистки

Для перевода станции в режим очистки нужно задать станции номер 249.
В режиме очистки станция проводит очистку всех страниц чипа кроме страницы с номером чипа.
В страницу времени инициализации записывается новое время,
которое используется при подсчёте результатов, поэтому важно чтобы время на станции было корректным.

При поднесении чипа, на станции загорается светодиод и мигает до тех пор пока не закончится очистка (около 4 секунд).
При успешной очистке станция издает сигнал, светодиод гаснет, чип нужно убрать.
Если сигнала не было, очистка не была завершена, нужно повторить процедуру.

### Станция проверки

Для перевода станции в режим проверки нужно задать станции номер 248.
В режиме проверки станция не записывает данные на чип, а только проверяет его.
Если чип содержит отметки или время инициализации превышает время на станции более чем на 180 дней, станция молчит.
Если всё в порядке, то станция издаёт один короткий сигнал.
Время проверки примерно совпадает со временем отметки поэтому участники могут на этой станции потренировать отметку.

### Система паролей

Для защиты от несанкционированного перепрограммирования установленных станций используется система паролей.

Пароль состоит из трех чисел от 0 до 255 (трех байт).
Пароль по умолчанию — 0-0-0.
Все мастер-чипы содержат пароль, и работают только при условии совпадения паролей на чипе и на станции.
Для передачи пароля на станцию отметки используется мастер-чип настроек.
Пароль станции хранят в энергонезависимой памяти (EEPROM). 

### Сигналы

Ошибки:

| Число сигналов | Продолжительность сигнала, мс | Значение |
| --- | --- | --- |
| 3 | 100 | Неверно идут часы
| 4 | 100 | Неверный пароль на мастер-чипе
| 5 | 100 | Низкий заряд батареи
| 4 |  50 | Неизвестный мастер-чип
| 2 | 250 | Ошибка мастер-чипа
| 2 | 250 | Ошибка последовательного интерфейса

Нормальное поведение:

| Число сигналов | Продолжительность сигнала, мс | Значение |
| --- | --- | --- |
| 1 | 1000 | Батарея в норме, конец загрузки станции
| 1 |  500 | Успешная отметка, проверка или очистка
| 2 |  250 | Отметка уже записана на чип
| 1 |  250 | Прочитан мастер-чип
| 4 |  500 | Вход в режим сна
| 1 |  250 | Подтверждение для последовательного интерфейса


